<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AceTrack</title>
    <style>


:root {
    --primary: #667eea;
    --primary-dark: #5568d3;
    --secondary: #764ba2;
    --success: #4caf50;
    --danger: #f44336;
    --warning: #ff9800;
    --info: #2196f3;
    --light: #f8f9fa;
    --dark: #212529;
    --gray: #6c757d;
    --gray-light: #e9ecef;
    --border: #dee2e6;
    --shadow: rgba(0, 0, 0, 0.1);
    --shadow-lg: rgba(0, 0, 0, 0.15);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--light);
    color: var(--dark);
    line-height: 1.6;
}

.app-header {
    background: linear-gradient(90deg, #3A18D1, #4DB8F0);
    color: white;
    padding: 1rem;
    box-shadow: 0 2px 10px var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-content h1 {
    font-size: 1.5rem;
}

.header-actions {
    display: flex;
    gap: 0.5rem;
}

.icon-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1.2rem;
}

.icon-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.main-nav {
    background: white;
    padding: 0.5rem 1rem;
    box-shadow: 0 2px 5px var(--shadow);
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    position: sticky;
    top: 70px;
    z-index: 99;
}

.nav-btn {
    background: transparent;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
    position: relative;
}

.nav-btn:hover {
    background: var(--gray-light);
}

.nav-btn.active {
    background: var(--primary);
    color: white;
}

.badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background: var(--danger);
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 0.7rem;
}

.badge.hidden {
    display: none;
}

.main-content {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.view {
    display: none;
}

.view.active {
    display: block;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px var(--shadow);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px var(--shadow-lg);
}

.stat-icon {
    font-size: 2.5rem;
}

.stat-content h3 {
    font-size: 2rem;
    color: var(--primary);
}

.stat-content p {
    color: var(--gray);
    font-size: 0.9rem;
}

.dashboard-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.dashboard-section {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px var(--shadow);
}

.dashboard-section h2 {
    color: var(--primary);
    margin-bottom: 1rem;
}

.view-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.view-header h2 {
    color: var(--primary);
    font-size: 1.75rem;
}

.btn-primary, .btn-secondary {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: var(--gray-light);
    color: var(--dark);
}

.goals-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.goal-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px var(--shadow);
    border-left: 4px solid var(--primary);
    transition: all 0.3s;
}

.goal-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px var(--shadow-lg);
}

.goal-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.goal-title {
    font-size: 1.25rem;
    font-weight: 600;
}

.goal-actions button {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0.25rem;
    margin-left: 0.5rem;
}

.goal-description {
    color: var(--gray);
    margin-bottom: 1rem;
}

.goal-meta {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}

.tag {
    background: var(--gray-light);
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
}

.priority-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

.priority-5 { background: #ffebee; color: #c62828; }
.priority-4 { background: #fff3e0; color: #e65100; }
.priority-3 { background: #fff9c4; color: #f57f17; }
.priority-2 { background: #e8f5e9; color: #2e7d32; }
.priority-1 { background: #e3f2fd; color: #1565c0; }

.progress-bar {
    width: 100%;
    height: 8px;
    background: var(--gray-light);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: var(--success);
    transition: width 0.5s;
}

.filters-bar {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px var(--shadow);
    margin-bottom: 1.5rem;
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    gap: 1rem;
}

.filters-bar input, .filters-bar select {
    padding: 0.75rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 0.95rem;
}

.filters-bar input:focus, .filters-bar select:focus {
    outline: none;
    border-color: var(--primary);
}

.tasks-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.task-item {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px var(--shadow);
    border-left: 4px solid var(--primary);
    transition: all 0.3s;
}

.task-item.completed {
    opacity: 0.6;
    border-left-color: var(--success);
}

.task-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
}

.task-title-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.task-checkbox {
    width: 24px;
    height: 24px;
    cursor: pointer;
}

.task-title {
    font-size: 1.1rem;
    font-weight: 600;
}

.task-item.completed .task-title {
    text-decoration: line-through;
    color: var(--gray);
}

.task-actions button {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.1rem;
    padding: 0.25rem;
    margin-left: 0.5rem;
}

.task-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    font-size: 0.9rem;
    color: var(--gray);
}

.timeline-container, .calendar-container {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 10px var(--shadow);
    overflow-x: auto;
}

.timeline-row {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    min-height: 50px;
}

.timeline-label {
    width: 150px;
    font-weight: 600;

}

.timeline-track {
    flex: 1;
    height: 40px;
    background: var(--gray-light);
    border-radius: 8px;
    position: relative;

}

.timeline-bar {
    position: absolute;
    height: 100%;
    border-radius: 8px;
    color: white;
    padding: 0 0.5rem;
    display: flex;
    align-items: center;
    font-size: 0.85rem;
    cursor: pointer;

}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    margin-top: 1rem;

}

.calendar-day-header {
    text-align: center;
    font-weight: 600;
    padding: 0.75rem;

}

.calendar-day {
    aspect-ratio: 1;
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 0.5rem;
    cursor: pointer;
    min-height: 80px;

}

.calendar-day:hover {
    border-color: var(--primary);
    background: var(--gray-light);

}

.calendar-day.today {
    border-color: var(--primary);


    background: rgba(102, 126, 234, 0.1);
}

.calendar-day.other-month {
    opacity: 0.3;
}

.calendar-task-dot {
    width: 100%;
    height: 4px;
    border-radius: 2px;
    background: var(--primary);
    margin-top: 0.25rem;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;

    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px var(--shadow-lg);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1.5rem;
}

.modal-header h3 {

    color: var(--primary);
    font-size: 1.5rem;
}

.close-btn {
    background: transparent;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: var(--gray);
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}


.form-group label {
    display: block;
    margin-bottom: 0.5rem;

    font-weight: 600;
}

.form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.reminder-options {
    background: var(--gray-light);
    padding: 1rem;

    border-radius: 8px;
    margin-top: 1rem;
}

.reminder-options.hidden {
    display: none;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--gray);
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;

}

.task-compact, .goal-compact {
    padding: 0.75rem;
    background: var(--gray-light);
    border-radius: 8px;

    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.reminders-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.reminder-item {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px var(--shadow);

    display: flex;
    justify-content: space-between;
    align-items: center;

}

.reminder-actions button {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-left: 0.5rem;
}

.notification-toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 20px var(--shadow-lg);
    z-index: 2000;
    animation: slideIn 0.3s;
}

@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.notification-toast.success { border-left: 4px solid var(--success); }
.notification-toast.error { border-left: 4px solid var(--danger); }
.notification-toast.info { border-left: 4px solid var(--info); }


@media (max-width: 768px) {
    .filters-bar {
        grid-template-columns: 1fr;
    }
    .goals-grid {
        grid-template-columns: 1fr;
    }
    .form-row {
        grid-template-columns: 1fr;
    }
    .calendar-day {
        min-height: 60px;

        font-size: 0.85rem;
    }
}
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <h1>AceTrack</h1>
            <div class="header-actions">
                <button id="notificationBtn" class="icon-btn" title="Enable Notifications">🔔</button>
                <button id="exportBtn" class="icon-btn" title="Export Data">💾</button>
                <button id="importBtn" class="icon-btn" title="Import Data">📂</button>
                <button id="helpBtn" class="icon-btn" title="Help">❓</button>
            </div>
        </div>
    </header>


    <nav class="main-nav">
        <button class="nav-btn active" data-view="dashboard">📊 Dashboard</button>
        <button class="nav-btn" data-view="goals">🎯 Goals</button>
        <button class="nav-btn" data-view="tasks">✓ Tasks</button>
        <button class="nav-btn" data-view="timeline">📅 Timeline</button>
        <button class="nav-btn" data-view="calendar">📆 Calendar</button>
        <button class="nav-btn" data-view="reminders">⏰ Reminders <span id="reminderBadge" class="badge hidden">0</span></button>
    </nav>

    <main class="main-content">
        <!-- Dashboard View -->
        <div id="dashboardView" class="view active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">📋</div>
                    <div class="stat-content">
                        <h3 id="todayTasksCount">0</h3>

                        <p>Today's Tasks</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⏰</div>
                    <div class="stat-content">
                        <h3 id="upcomingReminders">0</h3>
                        <p>Upcoming Reminders</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">✓</div>
                    <div class="stat-content">
                        <h3 id="completionRate">0%</h3>
                        <p>Completion Rate</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⏱️</div>
                    <div class="stat-content">
                        <h3 id="totalMinutes">0</h3>
                        <p>Est. Minutes Left</p>
                    </div>
                </div>
            </div>
            <div class="dashboard-sections">
                <section class="dashboard-section">
                    <h2>Today's Tasks</h2>
                    <div id="todayTasksList"></div>
                </section>
                <section class="dashboard-section">
                    <h2>Active Goals</h2>
                    <div id="activeGoalsList"></div>
                </section>
            </div>
        </div>

        <!-- Goals View -->
        <div id="goalsView" class="view">
            <div class="view-header">
                <h2>Goals</h2>
                <button id="newGoalBtn" class="btn-primary">➕ New Goal</button>
            </div>
            <div id="goalsList" class="goals-grid"></div>
        </div>

        <!-- Tasks View -->
        <div id="tasksView" class="view">
            <div class="view-header">
                <h2>Tasks</h2>
                <button id="newTaskBtn" class="btn-primary">➕ New Task</button>
            </div>
            <div class="filters-bar">
                <input type="search" id="taskSearch" placeholder="Search tasks...">
                <select id="filterPriority">
                    <option value="">All Priorities</option>
                    <option value="5">Priority 5</option>
                    <option value="4">Priority 4</option>
                    <option value="3">Priority 3</option>
                    <option value="2">Priority 2</option>
                    <option value="1">Priority 1</option>
                </select>
                <select id="filterGoal">
                    <option value="">All Goals</option>
                </select>
                <select id="sortTasks">
                    <option value="dueDate">Sort by Due Date</option>
                    <option value="priority">Sort by Priority</option>
                    <option value="createdAt">Sort by Created</option>
                </select>
            </div>
            <div id="tasksList" class="tasks-list"></div>
        </div>

        <!-- Timeline View -->
        <div id="timelineView" class="view">
            <div class="view-header">
                <h2>Timeline</h2>
            </div>
            <div id="timelineContainer" class="timeline-container"></div>
        </div>

        <!-- Calendar View -->
        <div id="calendarView" class="view">
            <div class="view-header">
                <h2>Calendar</h2>
                <div>
                    <button id="prevMonth" class="btn-secondary">←</button>
                    <span id="currentMonth" style="margin: 0 1rem;"></span>
                    <button id="nextMonth" class="btn-secondary">→</button>
                    <button id="todayBtn" class="btn-secondary">Today</button>
                </div>
            </div>
            <div id="calendarContainer" class="calendar-container"></div>
        </div>

        <!-- Reminders View -->
        <div id="remindersView" class="view">
            <div class="view-header">
                <h2>Reminders</h2>
            </div>
            <div id="remindersList" class="reminders-list"></div>
        </div>
    </main>

    <!-- Goal Modal -->
    <div id="goalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="goalModalTitle">New Goal</h3>
                <button class="close-btn" onclick="app.closeGoalModal()">&times;</button>
            </div>
            <form id="goalForm">
                <input type="hidden" id="goalId">
                <div class="form-group">
                    <label for="goalTitle">Title *</label>
                    <input type="text" id="goalTitle" required>
                </div>
                <div class="form-group">
                    <label for="goalDescription">Description</label>
                    <textarea id="goalDescription" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="goalColor">Color</label>
                        <input type="color" id="goalColor" value="#667eea">
                    </div>
                    <div class="form-group">
                        <label for="goalPriority">Priority</label>
                        <select id="goalPriority">
                            <option value="1">1 - Low</option>
                            <option value="2">2</option>
                            <option value="3" selected>3 - Medium</option>
                            <option value="4">4</option>
                            <option value="5">5 - High</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="goalTimelineStart">Start Date</label>
                        <input type="date" id="goalTimelineStart">
                    </div>
                    <div class="form-group">
                        <label for="goalTimelineEnd">End Date</label>
                        <input type="date" id="goalTimelineEnd">
                    </div>
                </div>
                <div class="form-group">
                    <label for="goalTags">Tags (comma-separated)</label>
                    <input type="text" id="goalTags" placeholder="exam, project, review">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="app.closeGoalModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Goal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="taskModalTitle">New Task</h3>
                <button class="close-btn" onclick="app.closeTaskModal()">&times;</button>
            </div>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="form-group">
                    <label for="taskTitle">Title *</label>
                    <input type="text" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label for="taskGoal">Goal</label>
                    <select id="taskGoal">
                        <option value="">No Goal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskNotes">Notes</label>
                    <textarea id="taskNotes" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskEstimatedMinutes">Est. Minutes</label>
                        <input type="number" id="taskEstimatedMinutes" min="1" value="60">
                    </div>
                    <div class="form-group">
                        <label for="taskPriority">Priority</label>
                        <select id="taskPriority">
                            <option value="1">1 - Low</option>
                            <option value="2">2</option>
                            <option value="3" selected>3 - Medium</option>
                            <option value="4">4</option>
                            <option value="5">5 - High</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="taskDueDate">Due Date *</label>
                    <input type="datetime-local" id="taskDueDate" required>
                </div>
                <div class="form-group">
                    <label for="taskTags">Tags (comma-separated)</label>
                    <input type="text" id="taskTags" placeholder="homework, reading">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reminderEnabled">
                        Enable Reminder
                    </label>
                </div>
                <div id="reminderOptions" class="reminder-options hidden">
                    <div class="form-group">
                        <label for="reminderAt">Reminder Time</label>
                        <input type="datetime-local" id="reminderAt">
                    </div>
                    <div class="form-group">
                        <label for="reminderRepeat">Repeat</label>
                        <select id="reminderRepeat">
                            <option value="none">None</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="app.closeTaskModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Help & Keyboard Shortcuts</h3>
                <button class="close-btn" onclick="app.closeHelpModal()">&times;</button>
            </div>
            <div style="max-width: 500px;">
                <section style="margin-bottom: 2rem;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Keyboard Shortcuts</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                            <kbd>Alt+N</kbd> - New Task
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                            <kbd>Alt+G</kbd> - New Goal
                        </li>
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                            <kbd>/</kbd> - Focus Search
                        </li>
                        <li style="padding: 0.5rem 0;">
                            <kbd>Esc</kbd> - Close Modal
                        </li>
                    </ul>
                </section>
                <section style="margin-bottom: 2rem;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">About</h4>
                    <p>AceTrack v1.0</p>
                    <p>A productivity tool to manage your study goals, tasks, and reminders.</p>
                    <p>All data is stored locally in your browser.</p>
                </section>
                <section>
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">Data Management</h4>
                    <p>Use Export to download your data as JSON.</p>
                    <p>Use Import to restore from a backup.</p>
                </section>
            </div>
        </div>
    </div>

    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <script>


/* Storage */
const Storage = {
    STORAGE_KEY: 'AceTrack.v1',
    
    load() {
        try {
            const data = localStorage.getItem(this.STORAGE_KEY);
            return data ? JSON.parse(data) : this.getDefaultData();
        } catch (error) {
            console.error('Error loading data:', error);
            return this.getDefaultData();
        }
    },
    
    save(data) {
        try {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
            return true;
        } catch (error) {
            console.error('Error saving data:', error);
            return false;
        }
    },
    
    getDefaultData() {
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        const nextWeek = new Date(now);
        nextWeek.setDate(nextWeek.getDate() + 7);
        
        return {
            version: '1',
            settings: { notificationsAllowed: false },
            goals: [
                {
                    id: 'g1',
                    title: 'Mathematics Exam Prep',
                    description: 'Prepare for Calculus and Algebra finals',
                    color: '#ff8a65',
                    tags: ['exam', 'math'],
                    priority: 5,
                    tasks: ['t1', 't2'],
                    timelineStart: now.toISOString().split('T')[0],
                    timelineEnd: nextWeek.toISOString().split('T')[0],
                    createdAt: now.toISOString(),
                    updatedAt: now.toISOString()
                }
            ],
            tasks: [
                {
                    id: 't1',
                    goalId: 'g1',
                    title: 'Review Integration Techniques',
                    notes: 'Focus on integration by parts',
                    estimatedMinutes: 120,
                    dueDate: tomorrow.toISOString(),
                    completed: false,
                    priority: 5,
                    tags: ['calculus'],
                    reminder: {
                        enabled: true,
                        at: new Date(tomorrow.getTime() - 3600000).toISOString(),
                        repeat: 'none'
                    },
                    createdAt: now.toISOString(),
                    updatedAt: now.toISOString()
                },
                {
                    id: 't2',
                    goalId: 'g1',
                    title: 'Practice Algebra Problems',
                    notes: 'Chapter 5 exercises',
                    estimatedMinutes: 90,
                    dueDate: tomorrow.toISOString(),
                    completed: false,
                    priority: 4,
                    tags: ['algebra'],
                    reminder: { enabled: false, at: null, repeat: 'none' },
                    createdAt: now.toISOString(),
                    updatedAt: now.toISOString()
                }
            ]
        };
    },
    
    export() {
        const data = this.load();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `study-planner-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    },
    
    import(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.version && Array.isArray(data.goals) && Array.isArray(data.tasks)) {
                        this.save(data);
                        resolve(data);
                    } else {
                        reject(new Error('Invalid data format'));
                    }
                } catch (error) {
                    reject(error);
                }
            };
            reader.readAsText(file);
        });
    }
};

// ===========================
// Data Manager
// ===========================
const DataManager = {
    data: null,
    
    init() {
        this.data = Storage.load();
    },
    
    save() {
        Storage.save(this.data);
    },
    
    getGoals() { return this.data.goals; },
    getGoal(id) { return this.data.goals.find(g => g.id === id); },
    
    addGoal(goal) {
        goal.id = 'g' + Date.now();
        goal.createdAt = new Date().toISOString();
        goal.updatedAt = new Date().toISOString();
        goal.tasks = [];
        this.data.goals.push(goal);
        this.save();
        return goal;
    },
    
    updateGoal(id, updates) {
        const goal = this.getGoal(id);
        if (goal) {
            Object.assign(goal, updates);
            goal.updatedAt = new Date().toISOString();
            this.save();
        }
        return goal;
    },
    
    deleteGoal(id) {
        this.data.tasks = this.data.tasks.filter(t => t.goalId !== id);
        this.data.goals = this.data.goals.filter(g => g.id !== id);
        this.save();
    },
    
    getTasks() { return this.data.tasks; },
    getTask(id) { return this.data.tasks.find(t => t.id === id); },
    getTasksByGoal(goalId) { return this.data.tasks.filter(t => t.goalId === goalId); },
    
    addTask(task) {
        task.id = 't' + Date.now();
        task.createdAt = new Date().toISOString();
        task.updatedAt = new Date().toISOString();
        this.data.tasks.push(task);
        
        if (task.goalId) {
            const goal = this.getGoal(task.goalId);
            if (goal && !goal.tasks.includes(task.id)) {
                goal.tasks.push(task.id);
            }
        }
        this.save();
        return task;
    },
    
    updateTask(id, updates) {
        const task = this.getTask(id);
        if (task) {
            const oldGoalId = task.goalId;
            Object.assign(task, updates);
            task.updatedAt = new Date().toISOString();
            
            if (oldGoalId !== task.goalId) {
                if (oldGoalId) {
                    const oldGoal = this.getGoal(oldGoalId);
                    if (oldGoal) oldGoal.tasks = oldGoal.tasks.filter(tid => tid !== id);
                }
                if (task.goalId) {
                    const newGoal = this.getGoal(task.goalId);
                    if (newGoal && !newGoal.tasks.includes(id)) newGoal.tasks.push(id);
                }
            }
            this.save();
        }
        return task;
    },
    
    deleteTask(id) {
        const task = this.getTask(id);
        if (task && task.goalId) {
            const goal = this.getGoal(task.goalId);
            if (goal) goal.tasks = goal.tasks.filter(tid => tid !== id);
        }
        this.data.tasks = this.data.tasks.filter(t => t.id !== id);
        this.save();
    },
    
    toggleTaskComplete(id) {
        const task = this.getTask(id);
        if (task) {
            task.completed = !task.completed;
            task.updatedAt = new Date().toISOString();
            this.save();
        }
        return task;
    },
    
    getTodayTasks() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        return this.data.tasks.filter(t => {
            const dueDate = new Date(t.dueDate);
            return dueDate >= today && dueDate < tomorrow && !t.completed;
        });
    },
    
    getUpcomingReminders() {
        const now = new Date();
        const next24h = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        
        return this.data.tasks.filter(t => {
            if (!t.reminder || !t.reminder.enabled || t.completed) return false;
            const reminderTime = new Date(t.reminder.at);
            return reminderTime >= now && reminderTime <= next24h;
        }).sort((a, b) => new Date(a.reminder.at) - new Date(b.reminder.at));
    },
    
    getCompletionRate() {
        const total = this.data.tasks.length;
        if (total === 0) return 0;
        const completed = this.data.tasks.filter(t => t.completed).length;
        return Math.round((completed / total) * 100);
    },
    
    getTotalMinutes() {
        return this.data.tasks.filter(t => !t.completed)
            .reduce((sum, t) => sum + (t.estimatedMinutes || 0), 0);
    },
    
    updateSettings(settings) {
        Object.assign(this.data.settings, settings);
        this.save();
    },
    
    getSettings() {
        return this.data.settings;
    }
};

// ===========================
// Notification Manager
// ===========================
const NotificationManager = {
    checkInterval: null,
    notifiedReminders: new Set(),
    
    init() {
        this.startChecking();
    },
    
    async requestPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            const permission = await Notification.requestPermission();
            DataManager.updateSettings({ notificationsAllowed: permission === 'granted' });
            UI.showToast(
                permission === 'granted' ? 'Notifications enabled!' : 'Notifications denied',
                permission === 'granted' ? 'success' : 'error'
            );
        }
    },
    
    startChecking() {
        this.checkInterval = setInterval(() => this.checkReminders(), 60000);
        this.checkReminders();
    },
    
    checkReminders() {
        const reminders = DataManager.getUpcomingReminders();
        const now = new Date();
        
        reminders.forEach(task => {
            const reminderTime = new Date(task.reminder.at);
            const diff = reminderTime - now;
            
            if (diff <= 60000 && diff >= 0 && !this.notifiedReminders.has(task.id)) {
                this.showNotification(task);
                this.notifiedReminders.add(task.id);
                
                if (task.reminder.repeat !== 'none') {
                    this.scheduleNextReminder(task);
                }
            }
        });
        
        UI.updateReminderBadge();
    },
    
    showNotification(task) {
        const settings = DataManager.getSettings();
        
        if (settings.notificationsAllowed && 'Notification' in window && Notification.permission === 'granted') {
            new Notification('Study Reminder', {
                body: task.title,
                icon: '📚',
                tag: task.id
            });
        } else {
            UI.showToast(`Reminder: ${task.title}`, 'info');
        }
    },
    
    scheduleNextReminder(task) {
        const current = new Date(task.reminder.at);
        let next;
        
        switch (task.reminder.repeat) {
            case 'daily':
                next = new Date(current);
                next.setDate(next.getDate() + 1);
                break;
            case 'weekly':
                next = new Date(current);
                next.setDate(next.getDate() + 7);
                break;
            case 'monthly':
                next = new Date(current);
                next.setMonth(next.getMonth() + 1);
                break;
        }
        
        if (next) {
            DataManager.updateTask(task.id, {
                reminder: { ...task.reminder, at: next.toISOString() }
            });
            this.notifiedReminders.delete(task.id);
        }
    },
    
    snoozeReminder(taskId, minutes) {
        const task = DataManager.getTask(taskId);
        if (task) {
            const newTime = new Date(Date.now() + minutes * 60000);
            DataManager.updateTask(taskId, {
                reminder: { ...task.reminder, at: newTime.toISOString() }
            });
            this.notifiedReminders.delete(taskId);
            UI.showToast(`Reminder snoozed for ${minutes} minutes`, 'success');
            UI.render();
        }
    }
};

// ===========================
// UI Manager
// ===========================
const UI = {
    currentView: 'dashboard',
    currentMonth: new Date(),
    
    init() {
        this.setupNavigation();
        this.setupModals();
        this.setupForms();
        this.setupKeyboardShortcuts();
        this.setupButtons();
        this.render();
    },
    
    setupNavigation() {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => this.switchView(btn.dataset.view));
        });
    },
    
    switchView(viewName) {
        this.currentView = viewName;
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === viewName);
        });
        
        document.querySelectorAll('.view').forEach(view => {
            view.classList.remove('active');
        });
        document.getElementById(viewName + 'View').classList.add('active');
        
        this.renderCurrentView();
    },
    
    renderCurrentView() {
        switch (this.currentView) {
            case 'dashboard': this.renderDashboard(); break;
            case 'goals': this.renderGoals(); break;
            case 'tasks': this.renderTasks(); break;
            case 'timeline': this.renderTimeline(); break;
            case 'calendar': this.renderCalendar(); break;
            case 'reminders': this.renderReminders(); break;
        }
    },
    
    render() {
        this.renderCurrentView();
        this.updateReminderBadge();
    },
    
    renderDashboard() {
        const todayTasks = DataManager.getTodayTasks();
        const upcomingReminders = DataManager.getUpcomingReminders();
        
        document.getElementById('todayTasksCount').textContent = todayTasks.length;
        document.getElementById('upcomingReminders').textContent = upcomingReminders.length;
        document.getElementById('completionRate').textContent = DataManager.getCompletionRate() + '%';
        document.getElementById('totalMinutes').textContent = DataManager.getTotalMinutes();
        
        const todayList = document.getElementById('todayTasksList');
        todayList.innerHTML = todayTasks.length === 0 
            ? '<div class="empty-state"><p>No tasks due today! 🎉</p></div>'
            : todayTasks.map(task => `
                <div class="task-compact">
                    <input type="checkbox" ${task.completed ? 'checked' : ''} 
                           onchange="app.toggleTask('${task.id}')">
                    <span>${this.escapeHtml(task.title)}</span>
                </div>
            `).join('');
        
        const activeGoals = DataManager.getGoals().slice(0, 5);
        const goalsList = document.getElementById('activeGoalsList');
        goalsList.innerHTML = activeGoals.length === 0
            ? '<div class="empty-state"><p>No goals yet</p></div>'
            : activeGoals.map(goal => {
                const tasks = DataManager.getTasksByGoal(goal.id);
                const completed = tasks.filter(t => t.completed).length;
                const progress = tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0;
                
                return `
                    <div class="goal-compact" style="border-left: 4px solid ${goal.color}">
                        <strong>${this.escapeHtml(goal.title)}</strong>
                        <div class="progress-bar" style="margin-top: 0.5rem;">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <small style="color: var(--gray);">${completed}/${tasks.length} tasks</small>
                    </div>
                `;
            }).join('');
    },
    
    renderGoals() {
        const goals = DataManager.getGoals();
        const container = document.getElementById('goalsList');
        
        if (goals.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">🎯</div>
                    <p>No goals yet — click 'New Goal' to begin.</p>
                </div>
            `;
        } else {
            container.innerHTML = goals.map(goal => {
                const tasks = DataManager.getTasksByGoal(goal.id);
                const completed = tasks.filter(t => t.completed).length;
                const progress = tasks.length > 0 ? Math.round((completed / tasks.length) * 100) : 0;
                
                return `
                    <div class="goal-card" style="border-left-color: ${goal.color}">
                        <div class="goal-header">
                            <h3 class="goal-title">${this.escapeHtml(goal.title)}</h3>
                            <div class="goal-actions">
                                <button onclick="app.editGoal('${goal.id}')">✏️</button>
                                <button onclick="app.deleteGoal('${goal.id}')">🗑️</button>
                            </div>
                        </div>
                        ${goal.description ? `<p class="goal-description">${this.escapeHtml(goal.description)}</p>` : ''}
                        <div class="goal-meta">
                            ${goal.tags.map(tag => `<span class="tag">${this.escapeHtml(tag)}</span>`).join('')}
                            <span class="priority-badge priority-${goal.priority}">P${goal.priority}</span>
                        </div>
                        ${goal.timelineStart && goal.timelineEnd ? `
                            <div style="font-size: 0.85rem; color: var(--gray); margin: 0.5rem 0;">
                                📅 ${this.formatDate(goal.timelineStart)} - ${this.formatDate(goal.timelineEnd)}
                            </div>
                        ` : ''}
                        <div style="margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--gray); margin-bottom: 0.5rem;">
                                <span>${completed}/${tasks.length} tasks</span>
                                <span>${progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    },
    
    renderTasks() {
        let tasks = DataManager.getTasks();
        
        const searchTerm = document.getElementById('taskSearch').value.toLowerCase();
        const priorityFilter = document.getElementById('filterPriority').value;
        const goalFilter = document.getElementById('filterGoal').value;
        const sortBy = document.getElementById('sortTasks').value;
        
        if (searchTerm) {
            tasks = tasks.filter(t => 
                t.title.toLowerCase().includes(searchTerm) ||
                (t.notes && t.notes.toLowerCase().includes(searchTerm))
            );
        }
        
        if (priorityFilter) tasks = tasks.filter(t => t.priority === parseInt(priorityFilter));
        if (goalFilter) tasks = tasks.filter(t => t.goalId === goalFilter);
        
        tasks.sort((a, b) => {
            switch (sortBy) {
                case 'dueDate': return new Date(a.dueDate) - new Date(b.dueDate);
                case 'priority': return b.priority - a.priority;
                case 'createdAt': return new Date(b.createdAt) - new Date(a.createdAt);
                default: return 0;
            }
        });
        
        const goalFilterSelect = document.getElementById('filterGoal');
        const goals = DataManager.getGoals();
        goalFilterSelect.innerHTML = '<option value="">All Goals</option>' +
            goals.map(g => `<option value="${g.id}">${this.escapeHtml(g.title)}</option>`).join('');
        
        const container = document.getElementById('tasksList');
        
        if (tasks.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">✓</div>
                    <p>No tasks found</p>
                </div>
            `;
        } else {
            container.innerHTML = tasks.map(task => {
                const goal = task.goalId ? DataManager.getGoal(task.goalId) : null;
                const dueDate = new Date(task.dueDate);
                const isOverdue = dueDate < new Date() && !task.completed;
                
                return `
                    <div class="task-item ${task.completed ? 'completed' : ''}">
                        <div class="task-header">
                            <div class="task-title-row">
                                <input type="checkbox" class="task-checkbox" 
                                       ${task.completed ? 'checked' : ''}
                                       onchange="app.toggleTask('${task.id}')">
                                <span class="task-title">${this.escapeHtml(task.title)}</span>
                            </div>
                            <div class="task-actions">
                                <button onclick="app.editTask('${task.id}')">✏️</button>
                                <button onclick="app.deleteTask('${task.id}')">🗑️</button>
                            </div>
                        </div>
                        <div class="task-meta">
                            ${goal ? `<span>🎯 ${this.escapeHtml(goal.title)}</span>` : ''}
                            <span>📅 ${this.formatDateTime(task.dueDate)} ${isOverdue ? '⚠️' : ''}</span>
                            <span>⏱️ ${task.estimatedMinutes}min</span>
                            <span class="priority-badge priority-${task.priority}">P${task.priority}</span>
                        </div>
                        ${task.tags.length > 0 ? `
                            <div class="goal-meta">
                                ${task.tags.map(tag => `<span class="tag">${this.escapeHtml(tag)}</span>`).join('')}
                            </div>
                        ` : ''}
                        ${task.notes ? `<div style="color: var(--gray); margin-top: 0.5rem; font-size: 0.95rem;">📝 ${this.escapeHtml(task.notes)}</div>` : ''}
                        ${task.reminder && task.reminder.enabled ? `
                            <div style="font-size: 0.85rem; color: var(--warning); margin-top: 0.5rem;">
                                ⏰ ${this.formatDateTime(task.reminder.at)}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
    },
    
    renderTimeline() {
        const container = document.getElementById('timelineContainer');
        const goals = DataManager.getGoals().filter(g => g.timelineStart && g.timelineEnd);
        
        if (goals.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📅</div>
                    <p>No timeline data. Add goals with dates to see them here.</p>
                </div>
            `;
            return;
        }
        
        const allDates = [];
        goals.forEach(g => {
            allDates.push(new Date(g.timelineStart), new Date(g.timelineEnd));
        });
        
        const minDate = new Date(Math.min(...allDates));
        const maxDate = new Date(Math.max(...allDates));
        const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
        
        container.innerHTML = goals.map(goal => {
            const start = new Date(goal.timelineStart);
            const end = new Date(goal.timelineEnd);
            const startOffset = Math.floor((start - minDate) / (1000 * 60 * 60 * 24));
            const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            const leftPercent = (startOffset / totalDays) * 100;
            const widthPercent = (duration / totalDays) * 100;
            
            return `
                <div class="timeline-row">
                    <div class="timeline-label">${this.escapeHtml(goal.title)}</div>
                    <div class="timeline-track">
                        <div class="timeline-bar" 
                             style="left: ${leftPercent}%; width: ${widthPercent}%; background: ${goal.color};"
                             title="${this.escapeHtml(goal.title)}">
                            ${this.escapeHtml(goal.title)}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    },
    
    renderCalendar() {
        const year = this.currentMonth.getFullYear();
        const month = this.currentMonth.getMonth();
        
        document.getElementById('currentMonth').textContent = 
            new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        const container = document.getElementById('calendarContainer');
        const tasks = DataManager.getTasks();
        
        let html = '<div class="calendar-grid">';
        
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
            html += `<div class="calendar-day-header">${day}</div>`;
        });
        
        for (let i = firstDay - 1; i >= 0; i--) {
            html += `<div class="calendar-day other-month"><div class="calendar-day-number">${daysInPrevMonth - i}</div></div>`;
        }
        
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const isToday = date.toDateString() === today.toDateString();
            const dayTasks = tasks.filter(t => {
                const taskDate = new Date(t.dueDate);
                return taskDate.toDateString() === date.toDateString();
            });
            
            html += `
                <div class="calendar-day ${isToday ? 'today' : ''}">
                    <div class="calendar-day-number">${day}</div>
                    <div class="calendar-tasks">
                        ${dayTasks.slice(0, 3).map(t => 
                            `<div class="calendar-task-dot" style="background: ${t.goalId ? (DataManager.getGoal(t.goalId)?.color || 'var(--primary)') : 'var(--primary)'}"></div>`
                        ).join('')}
                        ${dayTasks.length > 3 ? `<small style="color: var(--gray);">+${dayTasks.length - 3} more</small>` : ''}
                    </div>
                </div>
            `;
        }
        
        const remainingDays = 42 - (firstDay + daysInMonth);
        for (let day = 1; day <= remainingDays; day++) {
            html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
        }
        
        html += '</div>';
        container.innerHTML = html;
    },
    
    renderReminders() {
        const reminders = DataManager.getUpcomingReminders();
        const container = document.getElementById('remindersList');
        
        if (reminders.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">⏰</div>
                    <p>No upcoming reminders in the next 24 hours</p>
                </div>
            `;
        } else {
            container.innerHTML = reminders.map(task => `
                <div class="reminder-item">
                    <div class="reminder-info">
                        <div class="reminder-title">${this.escapeHtml(task.title)}</div>
                        <div class="reminder-time">⏰ ${this.formatDateTime(task.reminder.at)}</div>
                    </div>
                    <div class="reminder-actions">
                        <button class="snooze-btn" onclick="app.snoozeReminder('${task.id}', 15)" 
                                style="background: var(--warning); color: white;">
                            Snooze 15min
                        </button>
                        <button class="done-btn" onclick="app.completeTask('${task.id}')"
                                style="background: var(--success); color: white;">
                            Mark Done
                        </button>
                    </div>
                </div>
            `).join('');
        }
    },
    
    updateReminderBadge() {
        const reminders = DataManager.getUpcomingReminders();
        const badge = document.getElementById('reminderBadge');
        if (reminders.length > 0) {
            badge.textContent = reminders.length;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    },
    
    setupModals() {
        document.getElementById('reminderEnabled').addEventListener('change', (e) => {
            document.getElementById('reminderOptions').classList.toggle('hidden', !e.target.checked);
        });
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    },
    
    setupForms() {
        document.getElementById('goalForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveGoal();
        });
        
        document.getElementById('taskForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveTask();
        });
        
        document.getElementById('taskSearch').addEventListener('input', () => this.renderTasks());
        document.getElementById('filterPriority').addEventListener('change', () => this.renderTasks());
        document.getElementById('filterGoal').addEventListener('change', () => this.renderTasks());
        document.getElementById('sortTasks').addEventListener('change', () => this.renderTasks());
    },
    
    setupButtons() {
        document.getElementById('newGoalBtn').addEventListener('click', () => this.openGoalModal());
        document.getElementById('newTaskBtn').addEventListener('click', () => this.openTaskModal());
        document.getElementById('notificationBtn').addEventListener('click', () => NotificationManager.requestPermission());
        document.getElementById('exportBtn').addEventListener('click', () => {
            Storage.export();
            this.showToast('Data exported successfully!', 'success');
        });
        document.getElementById('importBtn').addEventListener('click', () => {
            document.getElementById('importFileInput').click();
        });
        document.getElementById('importFileInput').addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                try {
                    await Storage.import(e.target.files[0]);
                    DataManager.init();
                    this.render();
                    this.showToast('Data imported successfully!', 'success');
                } catch (error) {
                    this.showToast('Import failed: ' + error.message, 'error');
                }
            }
        });
        document.getElementById('helpBtn').addEventListener('click', () => this.openHelpModal());
        
        document.getElementById('prevMonth').addEventListener('click', () => {
            this.currentMonth.setMonth(this.currentMonth.getMonth() - 1);
            this.renderCalendar();
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            this.currentMonth.setMonth(this.currentMonth.getMonth() + 1);
            this.renderCalendar();
        });
        document.getElementById('todayBtn').addEventListener('click', () => {
            this.currentMonth = new Date();
            this.renderCalendar();
        });
    },
    
    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            }
            if (e.key === '/' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                document.getElementById('taskSearch').focus();
            }
            if (e.altKey && e.key === 'n') {
                e.preventDefault();
                this.openTaskModal();
            }
            if (e.altKey && e.key === 'g') {
                e.preventDefault();
                this.openGoalModal();
            }
        });
    },
    
    openGoalModal(goalId = null) {
        const modal = document.getElementById('goalModal');
        const form = document.getElementById('goalForm');
        form.reset();
        
        if (goalId) {
            const goal = DataManager.getGoal(goalId);
            document.getElementById('goalModalTitle').textContent = 'Edit Goal';
            document.getElementById('goalId').value = goal.id;
            document.getElementById('goalTitle').value = goal.title;
            document.getElementById('goalDescription').value = goal.description || '';
            document.getElementById('goalColor').value = goal.color;
            document.getElementById('goalPriority').value = goal.priority;
            document.getElementById('goalTimelineStart').value = goal.timelineStart || '';
            document.getElementById('goalTimelineEnd').value = goal.timelineEnd || '';
            document.getElementById('goalTags').value = goal.tags.join(', ');
        } else {
            document.getElementById('goalModalTitle').textContent = 'New Goal';
            document.getElementById('goalId').value = '';
        }
        
        modal.classList.add('active');
    },
    
    closeGoalModal() {
        document.getElementById('goalModal').classList.remove('active');
    },
    
    saveGoal() {
        const id = document.getElementById('goalId').value;
        const goalData = {
            title: document.getElementById('goalTitle').value,
            description: document.getElementById('goalDescription').value,
            color: document.getElementById('goalColor').value,
            priority: parseInt(document.getElementById('goalPriority').value),
            timelineStart: document.getElementById('goalTimelineStart').value || null,
            timelineEnd: document.getElementById('goalTimelineEnd').value || null,
            tags: document.getElementById('goalTags').value.split(',').map(t => t.trim()).filter(t => t)
        };
        
        if (id) {
            DataManager.updateGoal(id, goalData);
            this.showToast('Goal updated!', 'success');
        } else {
            DataManager.addGoal(goalData);
            this.showToast('Goal created!', 'success');
        }
        
        this.closeGoalModal();
        this.render();
    },
    
    openTaskModal(taskId = null) {
        const modal = document.getElementById('taskModal');
        const form = document.getElementById('taskForm');
        form.reset();
        
        const goals = DataManager.getGoals();
        document.getElementById('taskGoal').innerHTML = '<option value="">No Goal</option>' +
            goals.map(g => `<option value="${g.id}">${this.escapeHtml(g.title)}</option>`).join('');
        
        if (taskId) {
            const task = DataManager.getTask(taskId);
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskGoal').value = task.goalId || '';
            document.getElementById('taskNotes').value = task.notes || '';
            document.getElementById('taskEstimatedMinutes').value = task.estimatedMinutes;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskDueDate').value = this.toLocalDateTime(task.dueDate);
            document.getElementById('taskTags').value = task.tags.join(', ');
            
            if (task.reminder && task.reminder.enabled) {
                document.getElementById('reminderEnabled').checked = true;
                document.getElementById('reminderOptions').classList.remove('hidden');
                document.getElementById('reminderAt').value = this.toLocalDateTime(task.reminder.at);
                document.getElementById('reminderRepeat').value = task.reminder.repeat;
            }
        } else {
            document.getElementById('taskModalTitle').textContent = 'New Task';
            document.getElementById('taskId').value = '';
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('taskDueDate').value = this.toLocalDateTime(tomorrow.toISOString());
        }
        
        modal.classList.add('active');
    },
    
    closeTaskModal() {
        document.getElementById('taskModal').classList.remove('active');
    },
    
    saveTask() {
        const id = document.getElementById('taskId').value;
        const taskData = {
            title: document.getElementById('taskTitle').value,
            goalId: document.getElementById('taskGoal').value || null,
            notes: document.getElementById('taskNotes').value,
            estimatedMinutes: parseInt(document.getElementById('taskEstimatedMinutes').value),
            priority: parseInt(document.getElementById('taskPriority').value),
            dueDate: new Date(document.getElementById('taskDueDate').value).toISOString(),
            tags: document.getElementById('taskTags').value.split(',').map(t => t.trim()).filter(t => t),
            reminder: {
                enabled: document.getElementById('reminderEnabled').checked,
                at: document.getElementById('reminderEnabled').checked ? 
                    new Date(document.getElementById('reminderAt').value).toISOString() : null,
                repeat: document.getElementById('reminderRepeat').value
            }
        };
        
        if (id) {
            taskData.completed = DataManager.getTask(id).completed;
            DataManager.updateTask(id, taskData);
            this.showToast('Task updated!', 'success');
        } else {
            taskData.completed = false;
            DataManager.addTask(taskData);
            this.showToast('Task created!', 'success');
        }
        
        this.closeTaskModal();
        this.render();
    },
    
    openHelpModal() {
        document.getElementById('helpModal').classList.add('active');
    },
    
    closeHelpModal() {
        document.getElementById('helpModal').classList.remove('active');
    },
    
    showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `notification-toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    },
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },
    
    formatDate(dateStr) {
        return new Date(dateStr).toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric' 
        });
    },
    
    formatDateTime(dateStr) {
        return new Date(dateStr).toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            hour: 'numeric', 
            minute: '2-digit' 
        });
    },
    
    toLocalDateTime(isoString) {
        const date = new Date(isoString);
        const offset = date.getTimezoneOffset();
        const localDate = new Date(date.getTime() - offset * 60000);
        return localDate.toISOString().slice(0, 16);
    }
};

// ===========================
// Application Controller
// ===========================
const app = {
    init() {
        DataManager.init();
        UI.init();
        NotificationManager.init();
    },
    
    toggleTask(id) {
        DataManager.toggleTaskComplete(id);
        UI.render();
    },
    
    editGoal(id) {
        UI.openGoalModal(id);
    },
    
    deleteGoal(id) {
        if (confirm('Delete this goal and all its tasks?')) {
            DataManager.deleteGoal(id);
            UI.showToast('Goal deleted', 'success');
            UI.render();
        }
    },
    
    editTask(id) {
        UI.openTaskModal(id);
    },
    
    deleteTask(id) {
        if (confirm('Delete this task?')) {
            DataManager.deleteTask(id);
            UI.showToast('Task deleted', 'success');
            UI.render();
        }
    },
    
    completeTask(id) {
        const task = DataManager.getTask(id);
        if (task && !task.completed) {
            DataManager.toggleTaskComplete(id);
            UI.showToast('Task completed!', 'success');
            UI.render();
        }
    },
    
    snoozeReminder(id, minutes) {
        NotificationManager.snoozeReminder(id, minutes);
    },
    
    closeGoalModal() {
        UI.closeGoalModal();
    },
    
    closeTaskModal() {
        UI.closeTaskModal();
    },
    
    closeHelpModal() {
        UI.closeHelpModal();
    }
};

// Initialize app when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => app.init());
} else {
    app.init();
}
    </script>
</body>
</html>